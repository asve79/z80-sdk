# z80-sdk zifi module

Описание: Библиотека ф-ций для работы через zifi модуль + демо программа.

Цель: сделать минимальной и простой набор ф-ций для работы с данными через Zifi

Именование макросов: Макрос именуется названием ф-ции с префиксом \_zifi

Как это будет работать:

- Инициализируем адаптер
- подключаемся к точке доступа
- Открываем соединение, при этом говорим где лежит приемный буфер и какие вызывать ф-ции при приеме или проблемах. Получаем ID.
- Отправляем/получаем данные
- Если надо открываем еще соединения, также со своими ф-циями реакции на данные
- Как надоело закрываем соединения
- Отключаемся от точки доступа

## TO DO / In progress / Done

# Основные ф-ции
- [x] init
- [x] list_ap
- [x] connect_ap
- [x] current_ip
- [x] disconnect_ap
- [x] ping
- [x] open_tcp
- [x] close_tcp
- [x] send
- [ ] receive

# Структуры
## Реестр соединений
```
;Структура реестра (16 байт)
;	descriptor[1]	+0	- дескриптор
;	bufer_addr[2]	+1	- адрес буфера
;	bufer_size[2]	+3	- крайний адрес буфера, до которого можно писать даныне (bufer_addr + размер буфера)
;	offset[2]	+5	- адрес первой ячейки буфера куда можно писать данные (bufer_addr+ptr)
;(todo) procs_pg[1]	+7	- номер страницы с процедурами
;(todo) procs_bank[1]	+8	- номер банки с процедурами
;(todo) rcv_exec[2]	+9	- адрес процедуры, которая запустится при приходе данных в буфер (on_reveved)
;(todo) rcv_dis[2]	+11	- адрес процедуры, вызываемой при обрыве соединения (on_disconnect)
;(todo) over_exec[2]	+13	- адрес процедуры, вызываемой при достижении конца буфера (on_overflow)
;(todo) reserved	+15	- зарезервировано
```

# Функции и макросы модуля

## init - Инициализация Zifi
Вых:
 A=0 - OK
 A=1 - ERROR

Вызов:
```
	call zifi.init
```
	или
```
	_zifi_init
```

## list_ap - Получить список доступных точек доступа
Вх:
 HL - адрес буфера
Вых:
 A=0 - ОК
 A=1 - ERROR
 HL  - указатель на буфер с выводом ESP

Вызов:
```
	ld hl,bufer
	call zifi.list_ap
```
	или
```
	_zifi_list_ap bufer
```

## current_ip - Получить текущий IP адрес
Вх:
 HL - адрес буфера
Вых:
 A=0 - ОК
 A=1 - ERROR
 HL  - указатель на буфер с выводом ESP

Вызов:
```
	ld hl,bufer
	call zifi.curremt_ip
```
	или
```
	_zifi_curremt_ip bufer
```

## connect_ap - Подключиться к точке доступа
Вх:
 HL - адрес буфера
 DE - адрес строки формата <ssid>.<pass>,0
Вых:
 A=0 - ОК
 A=1 - ERROR
 HL  - указатель на буфер с выводом ESP

Вызов:
```
	ld hl,bufer
	ld de,input
	call zifi.connect_ap
```
	или
```
	_zifi_connect_ap bufer, input
```

## disconnect_ap - Отключиться от точки доступа
Вх:
 HL - адрес буфера
Вых:
 A=0 - ОК
 A=1 - ERROR
 HL  - указатель на буфер с выводом ESP

Вызов:
```
	ld hl,bufer
	call zifi.disconnect_ap
```
	или
```
	_zifi_disconnect_ap bufer
```

## ping - PING адреса
Вх:
 HL - адрес буфера
 DE - адрес строки формата <addr>,0
Вых:
 A=0 - ОК
 A=1 - ERROR
 HL  - указатель на буфер с выводом ESP

Вызов:
```
	ld hl,bufer
	ld de,addr
	call zifi.ping
```
	или
```
	_zifi_ping bufer, addr
```

## open_tcp - Открыть TCP соединение
Вх:
     HL - буфер для операций.
     DE - address,0,port,0
     DE` - адрес приемного буфера для данного канала. Адрес будет зарегистрирован в реестре. При входящие данных по данному дескриптору будут отправляться в этот буфер
     BC - максимальный размер буфера
Вых:
     HL - указатель на сообщение
      A - 0-9 - Connection ID, #FF - ERROR

Вызов:
```
	ld hl,res_bufer
	ld de,addr_url
	exx
	ld de,rcv_buf
	BC,512
	call zifi.open_tcp
```
	или
```
	_zifi_open_tcp obufer, addr, rcv_buf, 512
```

## close_tcp - закрыть TCP соединение
Вх:
     HL - буфер для операций.
     A - номер соединения
Вых:
     HL - указатель на сообщение
	 A=0 - ОК
 	 A=1 - ERROR

Вызов:
```
	ld hl,bufer
	ld a,1
	call zifi.close_tcp
```
	или
```
	LD A,1
	_zifi_close_tcp bufer
```
