Описание драйвера клавиатуры AZKEYB для ASC CP/M

Точки входа:
- подпрограммы:
    CONIN - ввод символа с клавиатуры. Если буфер клавиатуры не пуст,
            извлекает из него очередной код клавиши и возвращает. Если
            буфер пуст, ожидает нажатия клавиши.
    INTKEY - должна вызываться по прерываниям, опрос клавиатуры
    KEYMAC - подпрограмма установки макросов (ускоренный набор 
             последовательностей клавиш)

- переменные:
    KEYMOD - текущий режим клавиатуры
        bit 0 - caps lock
        bit 1 - RUS lock
        bit 2 - Graph
        bit 3 - Ctrl Graph
        bit 4 - Koi7 0+1
        bit 5 - Koi7 0/1 or Koi8
        bit 6 - 40 keys
        bit 7 - Extended mode

Внешние зависимости:
- подпрограммы
    ZVUK - подпрограмма генерации простых звуков, B - длительность, D - период
    KURSET -
- файлы
    AZMAINDE.MAC - объявления констант CP/M, из которых используются:
        STKMOD - 
        SYSKEY

Константы:
    KDREBE - задержка для подавления дребезга клавиш, работает аналогично
             синклерскому бейсику
    REPDEL - задержка перед началом автоповтора. Работает аналогично
             системной переменной REPDEL синклер-бейсика
    REPPER - период автоповтора. Работает аналогично одноименной системной
             переменной синклер-бейсика
    MACLEN - размер буфера макросов

-----------------------


Условные обозначения реакции драйвера на нажатие клавиш:

'A' или 65 или 41H - помещение кода в буфер клавиатуры. При этом
издается характерный щелчок "нормального" нажатия на клавишу. Во время
работы дисковода прерывания не всегда разрешены, но с клавиатурой можно
по-прежнему работать, удерживая клавишу до щелчка.

-- - отсутствие помещения кода в буфер. Если при этом в скобках приводится
разъяснение - то нажатие этой комбинации приводит к побочным действиям.


-----------------------

Во всех режимах, кроме Extended mode, нажатие на цифры, пробел и Enter приводит
к следующим результатам, в зависимости от статуса Caps shift и Symbol shift,
по одному из двух вариантов.

Для конфигурации драйвера "40-keys" (активна при значении константы SYSKEY=0,
определяется в AZMAINDE.MAC), предположительно использовалась А. Шафиром:

клавиша  CAPS=0,SYMB=0    CAPS=1,SYMB=0       CAPS=0,SYMB=1      CAPS=1,SYMB=1
0        '0'              7FH (Backspace)     '_'                -- (Ext Mode Set)
1        '1'              1BH (Esc)           '!'                --
2        '2'              -- (CAPS lock)      '@'                -- (KOI7 0+1 Set)
3        '3'              -- (RUS lock)       '#'                -- (KOI8 Set)
4        '4'              -- (Ext graph lock) '$'                -- (IBM Alt Set)
5        '5'              08H (Cursor left)   '%'                --
6        '6'              1AH (Cursor down)   '&'                --
7        '7'              19H (Cursor Up)     "'"                --
8        '8'              18H (Cursor Right)  '('                --
9        '9'              -- (Graph lock)     ')'                -- (Ext Graph Lock)
SPACE    ' '              03H (ETX, Ctrl-C)   09H (Tab)          -- (Clear buffer)
ENTER    0DH (CR)         0AH (LF)            1FH (US)           -- (Clear Buffer)

Для конфигурации драйвера "58-keys" (SYSKEY=1), использовалась ASC на Spectrum +2:

клавиша  CAPS=0,SYMB=0    CAPS=1,SYMB=0       CAPS=0,SYMB=1      CAPS=1,SYMB=1
0        '0'              7FH (Backspace)     '_'                1FH (US)
1        '1'              -- (RUS lock)       '!'                09H (Tab, HT)
2        '2'              -- (CAPS lock)      '@'                -- (KOI7 0+1 Set)
3        '3'              1BH (Esc)           '#'                -- (KOI8 Set)
4        '4'              -- (Ext Mode Set)   '$'                -- (IBM Alt Set)
5        '5'              08H (Cursor Left)   '%'                --
6        '6'              1AH (Cursor Down)   '&'                --
7        '7'              19H (Cursor Up)     "'"                --
8        '8'              18H (Cursor Right)  '('                --
9        '9'              -- (Ext Graph lock) ')'                -- (Graph lock)
SPACE    ' '              03H (ETX, Ctrl-C)   -- (Clear buffer)  --
ENTER    0DH (CR)         0AH (LF)            --                 --

При нажатии комбинаций смены режима (Lock) или установки режима (Set) драйвер
не помещает в буфер кодов. Нажатие этих комбинаций приводит к изменению
состояния драйвера. Издается характерный подтверждающий звук. Для клавиш
смены режима блокируется автоповтор. Условно принято, что повторное нажатие комбинации
"Lock" отключает выбранный режим, а повторное нажатие Set ни к чему не приводит.


Extended mode:

Этот режим предназначен для ускоренного набора комбинаций (макросов); набора кодов
напрямую цифрами; вызова специальных команд. Расширенный режим автоматически отключается
после нажатия одной клавиши (с регистрами или без).

Специальные команды в Extended mode:
Space - "PAUSE". Устанавливает флаг в системной переменной QFLAGS
(ASC CP/M BIOS), который приводит к приостановлению исполнения
CP/M приложения. Отработка этого режима находится в другом файле,
а как оно работает на практике - я забыл уже. Предположительно
исполнение программы продолжается после нажатия любой клавиши. 

Caps-Space - "BREAK". Устанавливает флаг в системной переменной QFLAGS,
который приводит к прекращению исполняемой CP/M программы и возврату
в режим командной строки. Некий прообраз команды
"снять задачу" в многозадачной системе. Таким образом можно завершить
зависшую программу и вернуться в CP/M без перезагрузки компьютера,
если только она не перепахала память слишком сильно и не запретила
прерывания.

SYMB-1 (!) - "RESET". Стирает содержимое теневого ОЗУ и перезапускает
компьютер в бейсик-128. Подпрограмма сброса довольно длинная и в основном
настраивает нестандартные регистры расширения памяти ASH. Александр Шафир,
по рассказам ASC, имел расширение до 256Кб и довольно много хитрых режимов,
поэтому код настройки портов, по-видимому, в основном работает на схему
ASH.

Caps-Symp-P "LST_CO" (Scroll lock) - останавливает или возобновляет
прокрутку экрана посредством установки флага в QFLAGS, который,
предположительно, влияет на работу подпрограммы вывода символа.

Цифры 0-9 - набор десятичного кода. Завершается набор либо нажатием
трех цифр, либо нажатием клавиши ENTER, после чего набранный код
помещается в буфер клавиатуры. При наборе ошибочного кода (типа 256, 345)
в буфер клавиатуры ничего не помещается, но издается характерный
звук ошибки, блокируется автоповтор. Нажатие клавиши "ENTER" в режиме
Extended mode без набора кода приводит к помещению в буфер клавиатуры
предыдущего набранного кода.

Буквы A-Z - вызов макроса (заранее заданной последовательности кодов).
При отсутствии макроса, заданного на данную клавишу, выдается звук
ошибки. Если макрос задан, он помещается в буфер клавиатуры.

При запуске CP/M было определено, если я правильно помню, 3 макроса для
ускоренного набора команд:
- dir <ENTER> - для клавиши D
- user 0 <ENTER> - для клавиши U
- fcopy *.* 1 <ENTER> - для клавиши F

-------

В остальных режимах нажатие буквенных клавиш приводит к следующему:

При удерживаемых Caps shift и Symbol Shift нажатие букв дает код,
который равен номеру буквы в алфавите. A=1, B=2, C=3 и т.д.
Можно заметить, что этот эффект аналогичен действию кнопки Ctrl
на IBM-совместимых компьютерах. Указанные коды формируются независимо
от режима клавиатуры (CAPS, Rus, KOI7 и т.д.)

При удерживаемой Symbol Shift, аналогично, режим клавиатуры не влияет
на формируемый код. Коды от Symbol Shift + клавиш следующие:

клавиша код

A       '~'
B       '*'
C       '?'
D       '\'
E       1EH (ASCII RS) 
F       '{'
G       '}'
H       '^'
I       0 (ASCII NUL)
J       '-'
K       '+'
L       '='
M       '.'
N       ','
O       ';'
P       '"'
Q       1DH (ASCII GS)
R       '<'
S       '|'
T       '>'
U       ']'
V       '/'
W       1CH (ASCII FS)
X       '`'
Y       '['
Z       ':'

Без удержания регистровых клавиш или при удержании CAPS Shift,
режим клавиатуры определяет формируемый код. Приоритет имеют режимы
графики: сначала Ctrl Graph, потом просто Graph. В режиме Ctrl Graph
отображаются разные экзотические символы и "боковые" русские буквы,
такие как "Х", "Ъ", "Ж", "Э" и т.д. Этот режим автоматически отключается
после набора одного символа. Повышает удобство при наборе русского
текста. В режиме просто Graph отображаются ASCII-символы рисования
линий, одинарные или двойные, в зависимости от Caps Shift и Caps Lock.

Оставшиеся режимы - нормальные латинский и русский. Возвращается
ASCII-код клавиши, заглавный или прописной в зависимости от Caps Shift.
Для русских букв возможен выбор из трех различных кодировок:
альтернаятивная кодировка ГОСТа, также известная как CP866;
КОИ7/0+1, КОИ8. для русских букв используется альтернативная кодировка ГОСТа,
также известная как CP866. 
